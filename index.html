<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="build/react.js"></script>
    <script src="build/react-dom.js"></script>
    <script src="build/browser.min.js"></script>
    <script src="build/jquery.min.js"></script>
  </head>
  <body>
    <div id="container"></div>
    <script type="text/babel">


      var ButtonPanel = React.createClass({

      	render: function() {
      		var isPlaying = this.props.isPlaying;
      		var isPause = this.props.isPause;
      		var isShowPlayBtn = !isPlaying || isPause;
      		var buttonClickHandler = isShowPlayBtn ? this.props.onPlayBtnClick : this.props.onPauseBtnClick;
          var classnames = isShowPlayBtn? 'player-play-pause-stop' : 'player-play-pause-stop playing';
    			return (
    				<button className={classnames} onClick={buttonClickHandler}></button>
    			);
      	}
      });

      var AudioPlayer = React.createClass({

        getInitialState: function() {
          return {
            isPlaying: false,
            isPause: false,
            volume: 0.5
          }
        },

        componentDidUpdate: function() {

        },

        render: function() {
          var percent = 0;

          return (
            <div className='audio-player'>
              <div className='player'>
                <audio controls preload='false' ref='audio' onTimeUpdate={this.onTimeUpdate} onEnded={this.onEnded}>
                  <source src="http://pd.npr.org/anon.npr-mp3/npr/atc/2016/04/20160421_atc_the_arctic_suicides_its_not_the_dark_that_kills_you.mp3?orgId=1&topicId=1031&aggIds=475000154&d=495&p=2&story=474847921&t=progseg&e=475082290&seg=4&siteplayer=true" />
                </audio>
              </div>
              <div className='clearfix'>
                <ButtonPanel isPlaying={this.state.isPlaying} isPause={this.state.isPause} onPlayBtnClick={this.onPlayBtnClick} onPauseBtnClick={this.onPauseBtnClick} />
                <div ref='progressBar' className='audio-progress-container' onClick={this.onProgressClick} onMouseDown={this.onProgressMouseDown} onTouchMove={this.onProgressTouchMove}>
                  <div ref='progress' className='audio-progress'></div>
                </div>
              </div>
              <div className='audio-desc-container clearfix'>
                <span className="audio-name-label pull-left">The Arctic Suicides: Its Not The Dark That Kills You</span>
              </div>
            </div>
          );
        },

        onPlayBtnClick: function() {
          if(this.state.isPlaying && !this.state.isPause) {
            return;
          }
          this.play();
        },

        onPauseBtnClick: function() {
          this.setState({isPause: !this.state.isPause});
          !this.state.isPause ? this.pause() : this._play();
        },

        play: function() {
          this.setState({isPlaying: true, isPause: false});
          this._play();
        },

        _play: function() {
          this.refs.audio.play();
        },

        pause: function() {
          this.refs.audio.pause();
        },

        onEnded: function() {
          this.refs.audio.pause();
        },

        onTimeUpdate: function() {
          var curtime = this.refs.audio.currentTime;
          var percent = (curtime/this.refs.audio.duration)*100;
          this.updateProgress(percent);
        },

        updateProgress: function(percent) {
          $(this.refs.progress).css('width', (percent + '%'));
        },

        changeTime: function(percent) {
          var t = (this.refs.audio.duration * percent);
          this.refs.audio.currentTime = t;
        },

        onProgressClick: function(e) {
          var x;
    			if (e.targetTouches) {
    				x = e.targetTouches[0].pageX;
    			} else {
    				x = e.clientX;
    			}
          this._progress(x);
        },

        onProgressMouseDown: function(e) {
          var x;
    			if (e.targetTouches) {
    				x = e.targetTouches[0].pageX;
    			} else {
    				x = e.clientX;
    			}
          this._progress(x);
        },

        onProgressTouchMove: function(e) {
          var x = e.targetTouches[0].pageX;
          this._progress(x);
        },

        _progress: function(x) {
          var progressBar = $(this.refs.progressBar);
          // 小数
          var percent = (x - progressBar.offset().left) / progressBar.width();
    			this.updateProgress(percent);
    			this.changeTime(percent);
        }

      });

      ReactDOM.render(
        <AudioPlayer />,
        document.getElementById('container')
      );

    </script>
  </body>
</html>
